<!DOCTYPE html>
<html>
<head>
  <title>Imagery Questionnaires</title>
  <meta charset="UTF-8"> <!-- Specify UTF-8 encoding -->
  <!-- jsPsych core library -->
  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <!-- jsPsych css -->
  <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css"/>
  <!-- jsPsych survey-likert plugin -->
  <script src="https://unpkg.com/@jspsych/plugin-survey-likert@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
  <!-- jsPsych survey-multi-choice plugin -->
  <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"></script>
  <script src="questionnaires.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.0.2/papaparse.min.js"></script>
  <style>
  /* General Style Adjustments */
  .jspsych-display-element {
    font-family: Arial, sans-serif; /* Improving readability */
/*    font-size: 30px;*/
  }

  /* Custom style for instructions */
  .vviq-instructions {
    font-weight: bold;
    font-size: larger;
    margin-bottom: 20px;
  }

</style>
</head>
<body>

  <script>

      // Create a timeline
      let timeline = [];

function reshapeDataAndDisplay() {
    var allData = jsPsych.data.get().filterCustom(function(trial) {
        return trial.trial_type === 'survey-multi-choice' || trial.trial_type === 'survey-likert';
    }).values();

    // Initialize a structure to store the reshaped data
    var reshapedData = [];

    // Initialize an object to keep track of responses and metadata by item_id
    var itemResponses = {};

    allData.forEach(function(trial) {
        // Example: trial.item_ids might be ["vviq-1", "vviq-2", "vviq-3", "vviq-4"] for a given trial
        trial.item_ids.forEach((itemId, index) => {
            // Ensure an entry exists for this item_id
            if (!itemResponses[itemId]) {
                // Initialize with metadata from questionnaires.js
                let itemData = irq.concat(osivq, vviq).find(item => item.item_id === itemId);
                itemResponses[itemId] = {
                    item_id: itemId,
                    responses: []
                };
            }

            // Assuming trial.response is an object where the keys are question names/ids matching item_ids
            let response = trial.response[`Q${index+1}`]; // Adjust based on how your data is structured
            itemResponses[itemId].responses.push(response || "No response");
        });
    });

    // Transform itemResponses into an array structure for easier display/export
    Object.values(itemResponses).forEach(item => {
        reshapedData.push({
            item_id: item.item_id,
            ...item.responses.reduce((acc, response, index) => {
                acc[`Response ${index + 1}`] = response;
                return acc;
            }, {})
        });
    });

    // Display or further process reshapedData as needed
    console.log(reshapedData);
    document.body.innerHTML = '<pre>' + JSON.stringify(reshapedData, null, 2) + '</pre>';
}


    



      // Shuffle the items array
      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]]; // Swap elements
        }
      }

      shuffleArray(irq); // Shuffle the items initially

      /// Function to generate a trial for a chunk of items
      function generateTrial(itemsChunk) {
        return {
          type: jsPsychSurveyLikert,
          questions: itemsChunk.map(item => ({
            prompt: item.item,
            labels: ['1', '2', '3', '4', '5'],
            required: true
          })),
          on_finish: function(data) {
            // Correctly attach additional data to the data object
            data.item_ids = itemsChunk.map(i => i.item_id);
            data.items = itemsChunk.map(i => i.item);
            data.categories = itemsChunk.map(i => i.category);
            data.questionnaires = itemsChunk.map(i => i.questionnaire);
          }
        };
      }

      // Chunk items into groups of 4 and add to timeline
      while (irq.length > 0) {
        let itemsChunk = irq.splice(0, 4); // Get next chunk of 5 items
        timeline.push(generateTrial(itemsChunk));
      }

      // // Shuffle the osivq array
      // shuffleArray(osivq); // Assuming shuffleArray function is already defined

      // // Function to generate a trial for a chunk of osivq items
      // function generateOsivqTrial(itemsChunk) {
      //   return {
      //     type: jsPsychSurveyLikert,
      //     questions: itemsChunk.map(item => ({
      //       prompt: item.item,
      //       labels: ['1', '2', '3', '4', '5'],
      //       required: true
      //     })),
      //     on_finish: function(data) {
      //       // Attach additional data to the data object
      //       data.item_ids = itemsChunk.map(i => i.item_id);
      //       data.items = itemsChunk.map(i => i.item);
      //       data.categories = itemsChunk.map(i => i.category);
      //       data.questionnaires = itemsChunk.map(i => i.questionnaire);
      //     }
      //   };
      // }

      // // Chunk osivq items into groups of 5 and add to timeline
      // while (osivq.length > 0) {
      //   let itemsChunk = osivq.splice(0, 5); // Get next chunk of 5 items
      //   timeline.push(generateOsivqTrial(itemsChunk));
      // }

      // Define the thank you screen
      var thankYouScreen = {
        type: jsPsychHtmlButtonResponse,
        stimulus: '<p><b>Thank you! Let\'s move to the next section.<br><br>Please read the instructions before moving to the next page.<br><br></b>Visual imagery refers to the ability to visualize, that is, the ability to form mental pictures, or to “see in the minds\’ eye.”<br><br>The aim of this test is to determine the vividness of your visual imagery. The items of the test will possibly bring certain images to your mind.<br><br>You are asked to rate the vividness of each image by reference to the 5-point scale given below: No image at all/ Vague and dim/ Moderately clear and vivid/ Reasonably clear and vivid/ Perfectly clear & vivid as if I was actually seeing it.<br><br>After reading each item, close your eyes for a moment, try to visualize the item, and then open your eyes and rate the item.</p>',
        choices: ['Continue']
      };
      // Add the thank you screen to the timeline after the IRQ part
      timeline.push(thankYouScreen);

      // Instruction messages for each VVIQ screen
      const vviqInstructions = [
        "In answering items 1 to 4, think of some relative or friend whom you frequently see and consider carefully the picture that comes your mind’s eye.",
        "In answering items 5 to 8, visualize a sun. Consider the picture that comes before you minds’ eye.",
        "In answering items 9 to 12, think of the front of a shop you often go to. Consider the picture that comes before you minds’ eye.",
        "Finally, think of the front of a country scene which involves trees, mountains, and a lake. Consider the picture that comes before you minds’ eye."
      ];


      // Adjust the loop to chunk VVIQ items into groups of 4 and add to timeline with instructions
      for (let i = 0; i < vviq.length; i += 4) {
          let itemsChunk = vviq.slice(i, i + 4); // Use slice to avoid modifying the original array
          let instructionIndex = i / 4; // Calculate instruction index based on the current chunk
          timeline.push(generateVVIQTrial(itemsChunk, instructionIndex));
      }

      function generateVVIQTrial(itemsChunk, instructionIndex) {
          return {
              type: jsPsychSurveyMultiChoice,
              preamble: `<div class="vviq-instructions">${vviqInstructions[instructionIndex]}</div>`, // Include the instruction
              questions: itemsChunk.map(item => ({
                  prompt: item.item,
                  options: ['No image at all, I only "know" I am thinking of the object',
                            'Dim and vague image',
                            'Moderately realistic and vivid',
                            'Realistic and reasonably vivid',
                            'Perfectly realistic, as vivid as real seeing'],
                  required: true
              })),
              on_finish: function(data) {
                  // Data processing
                  data.item_ids = itemsChunk.map(i => i.item_id);
                  data.items = itemsChunk.map(i => i.item);
                  data.categories = itemsChunk.map(i => i.category);
                  data.questionnaires = itemsChunk.map(i => i.questionnaire);
              }
          };
      }

      // Initialize jsPsych
      const jsPsych = initJsPsych({
        timeline: timeline,
        on_finish: function() {
          reshapeDataAndDisplay();
        }
      });
            

      // Run the experiment
      jsPsych.run(timeline);
  </script>
</body>
</html>