<!DOCTYPE html>
<html>
<head>
  <title>Imagery Questionnaires</title>
  <meta charset="UTF-8"> <!-- Specify UTF-8 encoding -->
  <!-- jsPsych core library -->
  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css"/>
  <script src="https://unpkg.com/@jspsych/plugin-survey-likert@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-multi-select@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.1"></script>
  <script src="questionnaires.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.0.2/papaparse.min.js"></script>
  <style>
  /* General Style Adjustments */
  .jspsych-display-element {
    font-family: Arial, sans-serif; /* Improving readability */
/*    font-size: 30px;*/
  }

  /* Custom style for vviq instructions */
  .vviq-instructions {
    font-weight: bold;
    font-size: larger;
    margin-bottom: 20px;
  }

  .continue_end_tasks{
    padding-bottom: 20px;
  }

  #jspsych-survey-multi-choice-next{
     margin-bottom: 20px;
  }
  

</style>
</head>
<body>

  <script>

      // Create a timeline
      let timeline = [];

      function reshapeDataAndDisplay() {
          // Fetch all data for Likert and Multi-Choice responses
          var allData = jsPsych.data.get().filterCustom(function(trial) {
            return trial.trial_type === 'survey-likert' || trial.trial_type === 'survey-multi-choice' || trial.trial_type === 'survey-multi-select' || trial.trial_type === 'survey-text'}).values();
          var reshapedData = [];

          allData.forEach(function(trial) {
              Object.keys(trial.response).forEach(function(questionKey) {
                  var index = parseInt(questionKey.replace('Q', ''), 10);
                  reshapedData.push({
                      trial_index: trial.trial_index,
                      time_elapsed: trial.time_elapsed,
                      internal_node_id: trial.internal_node_id,
                      response: trial.response[questionKey],
                      item_id: trial.item_ids ? trial.item_ids[index] : 'N/A',
                      item: trial.items ? trial.items[index] : 'N/A',
                      category: trial.categories ? trial.categories[index] : 'N/A',
                      questionnaire: trial.questionnaires ? trial.questionnaires[index] : 'N/A'
                  });
              });
          });

          var jsonData = JSON.stringify(reshapedData, null, 2);
          var pre = document.createElement('pre');
          pre.textContent = jsonData;
          document.body.innerHTML = '';
          document.body.appendChild(pre);
      }

      // // Shuffle the items array
      // function shuffleArray(array) {
      //   for (let i = array.length - 1; i > 0; i--) {
      //     const j = Math.floor(Math.random() * (i + 1));
      //     [array[i], array[j]] = [array[j], array[i]]; // Swap elements
      //   }
      // }

      // shuffleArray(irq); // Shuffle the items initially

      // /// Function to generate a trial for a chunk of items
      // function generateIrqTrial(itemsChunk) {
      //   return {
      //     type: jsPsychSurveyLikert,
      //     questions: itemsChunk.map(item => ({
      //       prompt: item.item,
      //       labels: ['1', '2', '3', '4', '5'],
      //       required: true
      //     })),
      //     on_finish: function(data) {
      //       data.item_ids = itemsChunk.map(i => i.item_id);
      //       data.items = itemsChunk.map(i => i.item);
      //       data.categories = itemsChunk.map(i => i.category);
      //       data.questionnaires = itemsChunk.map(i => i.questionnaire);
      //     }
      //   };
      // }

      // // Chunk items into groups of 4 and add to timeline
      // while (irq.length > 0) {
      //   let itemsChunk = irq.splice(0, 4); // Get next chunk of 4 items
      //   timeline.push(generateIrqTrial(itemsChunk));
      // }

      // // Shuffle the osivq array
      // shuffleArray(osivq);

      // // Function to generate a trial for a chunk of osivq items
      // function generateOsivqTrial(itemsChunk) {
      //   return {
      //     type: jsPsychSurveyLikert,
      //     questions: itemsChunk.map(item => ({
      //       prompt: item.item,
      //       labels: ['1', '2', '3', '4', '5'],
      //       required: true
      //     })),
      //     on_finish: function(data) {
      //       // Attach additional data to the data object
      //       data.item_ids = itemsChunk.map(i => i.item_id);
      //       data.items = itemsChunk.map(i => i.item);
      //       data.categories = itemsChunk.map(i => i.category);
      //       data.questionnaires = itemsChunk.map(i => i.questionnaire);
      //     }
      //   };
      // }

      // // Chunk osivq items into groups of 5 and add to timeline
      // while (osivq.length > 0) {
      //   let itemsChunk = osivq.splice(0, 5); // Get next chunk of 5 items
      //   timeline.push(generateOsivqTrial(itemsChunk));
      // }

      // // Define the thank you screen
      // var thankYouScreen = {
      //   type: jsPsychHtmlButtonResponse,
      //   stimulus: '<p><b>Thank you! Let\'s move to the next section.<br><br>Please read the instructions before moving to the next page.<br><br></b>Visual imagery refers to the ability to visualize, that is, the ability to form mental pictures, or to “see in the minds\’ eye.”<br><br>The aim of this test is to determine the vividness of your visual imagery. The items of the test will possibly bring certain images to your mind.<br><br>You are asked to rate the vividness of each image by reference to the 5-point scale given below: No image at all/ Vague and dim/ Moderately clear and vivid/ Reasonably clear and vivid/ Perfectly clear & vivid as if I was actually seeing it.<br><br>After reading each item, close your eyes for a moment, try to visualize the item, and then open your eyes and rate the item.</p>',
      //   choices: ['Continue']
      // };
      // timeline.push(thankYouScreen);

      // // Instruction messages for each VVIQ screen
      // const vviqInstructions = [
      //   "In answering items 1 to 4, think of some relative or friend whom you frequently see and consider carefully the picture that comes your mind’s eye.",
      //   "In answering items 5 to 8, visualize a sun. Consider the picture that comes before you minds’ eye.",
      //   "In answering items 9 to 12, think of the front of a shop you often go to. Consider the picture that comes before you minds’ eye.",
      //   "Finally, think of the front of a country scene which involves trees, mountains, and a lake. Consider the picture that comes before you minds’ eye."
      // ];


      // // Adjust the loop to chunk VVIQ items into groups of 4 and add to timeline with instructions
      // for (let i = 0; i < vviq.length; i += 4) {
      //     let itemsChunk = vviq.slice(i, i + 4); // Use slice to avoid modifying the original array
      //     let instructionIndex = i / 4; // Calculate instruction index based on the current chunk
      //     timeline.push(generateVVIQTrial(itemsChunk, instructionIndex));
      // }

      // function generateVVIQTrial(itemsChunk, instructionIndex) {
      //     return {
      //         type: jsPsychSurveyMultiChoice,
      //         preamble: `<div class="vviq-instructions">${vviqInstructions[instructionIndex]}</div>`, // Include the prompt
      //         questions: itemsChunk.map(item => ({
      //             prompt: item.item,
      //             options: ['No image at all, I only "know" I am thinking of the object',
      //                       'Dim and vague image',
      //                       'Moderately realistic and vivid',
      //                       'Realistic and reasonably vivid',
      //                       'Perfectly realistic, as vivid as real seeing'],
      //             required: true
      //         })),
      //         on_finish: function(data) {
      //             // Data processing
      //             data.item_ids = itemsChunk.map(i => i.item_id);
      //             data.items = itemsChunk.map(i => i.item);
      //             data.categories = itemsChunk.map(i => i.category);
      //             data.questionnaires = itemsChunk.map(i => i.questionnaire);
      //         }
      //     };
      // }


      // Define the thank you screen
     
      var endTasks = {
        type: jsPsychHtmlButtonResponse,
        stimulus: '<p><b>End of tasks.</b><br><br>Thank you, you have completed all of the tasks.<br><br>You will now be asked a short series of questions about yourself and your thoughts about the experiment.</p>',
        
        choices: ['Continue']
        
      };
      timeline.push(endTasks);




      // Demographics and debrief questions
      
      var demographicsDebriefQuestions = {
      
        timeline: [
          {
            type: jsPsychSurveyMultiChoice,
            
            questions: [
              {prompt: "Have you seen this study before?", options: ["Yes", "No"], required: true},
              {prompt: "What is your gender?", options: ["Woman", "Man", "Non-binary", "Prefer not to say", "Prefer to self-describe"], required: true},
              {prompt: "Which is your dominant hand?", options: ["Right", "Left"], required: true},
              // Removed the diagnosed conditions question from here
              {prompt: "Do you see normally (either with or without corrective lenses)?", options: ["Yes", "No"], required: true},
              {prompt: "Are you a native English speaker?", options: ["Yes", "No"], required: true},
              {prompt: "What is the highest degree or level of school you have completed?", options: ["High School", "Bachelor's Degree", "Master's Degree", "Doctoral Degree"], required: true}
            ],
            
          },
          {
            type: jsPsychSurveyMultiSelect, // Only this question uses the MultiSelect
            questions: [
              {prompt: "Have you ever been diagnosed with any of the following conditions? (Choose all that apply)", options: ["Dyslexia", "ADHD", "ASD", "No"], required: true}
            ],
          },
          {
            type: jsPsychSurveyText,
            questions: [
              {prompt: "How old are you?", rows: 1, columns: 3, required: true},
              {prompt: "What did you think the study was about?", rows: 5, columns: 40, required: true},
              {prompt: "Do you have any other feedback or thoughts about the experiment? (Optional)", rows: 5, columns: 40}
            ],
          }
        ],
        on_timeline_finish: function(){
          jsPsych.data.displayData(); // Display data at the end of the experiment
        }
      };
      timeline.push(demographicsDebriefQuestions);


      // Initialize jsPsych
      const jsPsych = initJsPsych({
        timeline: timeline,
        on_finish: function() {
          reshapeDataAndDisplay();
        }
      });



      // Run the experiment
      jsPsych.run(timeline);
      </script>

      </body>
      </html>