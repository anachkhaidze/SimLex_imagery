<!DOCTYPE html>
<html>
  <head>
    <title>SimLex Test </title>
    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />
    <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-likert plugin@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-canvas-slider-response@1.1.3"></script>
    <script src="https://unpkg.com/@multiSlider/plugin-canvas-slider-response@1.1.3"></script>
    <script src="simLex_dataset/trialInfoFull.js"></script>
    <style>
      body {
        font-family: sans-serif;
        margin: 20px;
      }
      .slider-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-bottom: 20px;
      }
      .slider {
        display: flex;
        align-items: center;
      }
      .slider-label {
        width: 500px;
        text-align: right;
      }
      .slider-input {
        flex: 1;
        opacity: 0.5
      }
      .slider-input.active {
        opacity: 1; /* Active opacity */
      }
      #next-button {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        background-color: #2980b9;
        color: white;
        cursor: pointer;
      }
      #next-button:enabled {
      background-color: #2980b9; /* Enabled state */
      opacity: 1;
    }
    </style>
  </head>
  <body>
    <div id="slider-container"></div>

  <script>
    function getLatestDocuments(jsonData) {
        const data = JSON.parse(jsonData);
        const groupedData = Object.values(data.reduce((acc, curr) => {
            acc[curr.item_id] = acc[curr.item_id] || [];
            acc[curr.item_id].push(curr);
            return acc;
        }, {}));
        return groupedData.map(group => group.reduce((latest, current) => (!latest || current.time > latest.time) ? current : latest));
    }

    document.addEventListener('DOMContentLoaded', (event) => {
      // initialize jsPsych
      var jsPsych = initJsPsych({
        on_finish: function() {
          var jsonData = jsPsych.data.get().json(true);
          const latestDocuments = getLatestDocuments(jsonData);
          console.log(latestDocuments);
          var pre = document.createElement('pre');
          pre.style.maxHeight = "500px";
          pre.style.overflowY = "scroll";
          pre.textContent = JSON.stringify(latestDocuments);
          var message = document.createElement('p');
          message.textContent = "Experiment data (JSON):";
          document.body.appendChild(message);
          document.body.appendChild(pre);
          var completionDiv = document.createElement('div');
          completionDiv.style.margin = "2em";
          completionDiv.innerHTML = "Completion message...";
          document.body.appendChild(completionDiv);
        }
      });
    var entries = [];
          
    var timeline = [];
    /* pick a random list for the subject at the start of the experiment */
    var list_assignment = jsPsych.randomization.sampleWithReplacement(['list_1', 'list_2'],1)[0];
    /* generate a random subject ID with 8 characters */
    var subject_id = jsPsych.randomization.randomID(8);
  
    generateTrials = function() {
      if (list_assignment == "list_1") {
        trialInfo = new Array(1).fill(trialList1).flat();
      } else if (list_assignment == "list_2") {
        trialInfo = new Array(1).fill(trialList2).flat();
      }
      for (let i = 0; i < 10; i++) {
        trialInfo[i].word1 = trialInfo[i].word1
        trialInfo[i].word2 = trialInfo[i].word2
        trialInfo[i].SimLex999 = trialInfo[i].SimLex999
        trialInfo[i].list = trialInfo[i].sd_simLex
        trialInfo[i].SimAssoc333 = trialInfo[i].SimAssoc333
        trialInfo[i].stim = trialInfo[i].stim
        trialInfo[i].stimulusID = trialInfo[i].stimulusID
        trialInfo[i].list = trialInfo[i].list
      }
      trialInfo = jsPsych.randomization.shuffle(trialInfo);
      return trialInfo;
    }

    pageWiseTrials = function() {
      trialInfo = generateTrials();
      var trialIndex = 0;
      var trialsPerPage = 5;
      var numberOfPages = Math.ceil(10/ trialsPerPage);
      var trialsPages = [];
      for (var i = 0; i < numberOfPages; i++) {
        trialsPages.push({'pageData': trialInfo.slice(i * trialsPerPage, (i + 1) * trialsPerPage)});
      }
      return trialsPages
    }
    // this adds a property called 'subject' and a property called 'condition' to every trial
    jsPsych.data.addProperties({
      subject: subject_id,
      list: list_assignment
    });
    
    var trial = {
      type: jsPsychHtmlKeyboardResponse, 
      choices: "NO_KEYS",       
      stimulus: function() {
        var htmlContent = '<div class="slider-container">';
        var pageEntry = jsPsych.timelineVariable('pageData');
        for (var i = 0; i < pageEntry.length; i++) {
          var trialData = pageEntry[i];
          htmlContent += `
              <div class="slider">
                <span class="slider-label">
                    <span class="math-inline">${trialData.stim}
                </span>
                  <input type="range"
                  class="slider-input"
                  min=0
                  max=6
                  step=1
                  value="3"
                  data-item-id="${trialData.stimulusID}"
                  data-index="${i}"
                  data-word1=${trialData.word1}
                  data-word2=${trialData.word2}
                  data-pos=${trialData.POS}
                  data-simlex=${trialData.SimLex999}
                  data-concwordone=${trialData.conc_word1}
                  data-concwordtwo=${trialData.conc_word2}
                  data-concq=${trialData.concQ}
                  data-assocusf=${trialData.assoc_usf}
                  data-stim=${trialData.stim}
                  data-simasoc=${trialData.SimAssoc333}
                  data-time=""
               >
               <span class="slider-value">3</span> <!-- Display initial slider value -->
               <br>
              </div>
            `;
          }
          htmlContent += '</div>';
          htmlContent += '<button id="next-button">Next</button>';
          return htmlContent;
        },
        prompt: '<p>Please fill all sliders before proceeding to the next page.</p>',
        on_load : function (data) {
          document.getElementById('next-button').disabled = true; 
          var sliders = document.querySelectorAll('.slider-input');
          // Function to check if all sliders have been moved
          var checkSlidersMoved = function() {
            var allMoved = true;
            sliders.forEach(function(slider) {
              if (!slider.classList.contains('active')) { // Check if the slider has the 'active' class
                allMoved = false;
              }
            });
            // document.getElementById('next-button').disabled = !allMoved;
          };
          sliders.forEach(function (slider) {
            slider.addEventListener('change', function () {
                jsPsych.data.get().push({
                    item_id: this.dataset.itemId,
                    index: this.dataset.index,
                    value: this.value,
                    word1: this.dataset.word1,
                    word2: this.dataset.word2,
                    pos: this.dataset.pos,
                    simlex: this.dataset.simlex,
                    concwordone: this.dataset.concwordone,
                    concwordtwo: this.dataset.concwordtwo,
                    concq: this.dataset.concq,
                    assocusf: this.dataset.assocusf,
                    stim: this.dataset.stim,
                    simasoc: this.dataset.simasoc,
                    time: new Date().getTime(),
                    subject: subject_id,
                    list: list_assignment
                });
            });


            slider.addEventListener('input', function () {
                // Mark the slider as 'active' to indicate it has been moved
                this.classList.add('active');

                // Check if all sliders have been moved
                checkSlidersMoved();
                
                var valueSpan = this.nextElementSibling;
                valueSpan.textContent = this.value;
                this.classList.add('active');
                var allFilled = true;
                sliders.forEach(function (s) {
                  if (s.value === "") {
                    allFilled = false;
                  }
                });
                if (allFilled) {
                  document.getElementById('next-button').disabled = false;
                }
              });
            });
            // make the button unclickable till all sliders are filled
            document.getElementById('next-button').addEventListener('click', function () {
                jsPsych.finishTrial();
            });
        }
    };
    var test_procedure = {
      timeline: [trial],
      timeline_variables: pageWiseTrials(),
    };
    timeline.push(test_procedure);
    jsPsych.run(timeline);

  });
</script>
</body>

</html>